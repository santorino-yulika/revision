import streamlit as st
import pandas as pd
import numpy as np

st.set_page_config(
    page_title="–†–µ–≤—ñ–∑—ñ—ó –∫–∞–≤ º—è—Ä–µ–Ω—å",
    layout="wide"
)

st.title("–û–±–ª—ñ–∫ —Ä–µ–≤—ñ–∑—ñ–π –∫–∞–≤ º—è—Ä–µ–Ω—å")

# ---------------------------
# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
# ---------------------------
uploaded_file = st.file_uploader(
    "–ó–∞–≤–∞–Ω—Ç–∞–∂ Excel-—Ñ–∞–π–ª –∑ —Ä–µ–≤—ñ–∑—ñ—è–º–∏",
    type=["xlsx"]
)

if uploaded_file is None:
    st.info("–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª Excel –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏")
    st.stop()

# ---------------------------
# –ß–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É
# ---------------------------
df = pd.read_excel(uploaded_file)

# ---------------------------
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤ º—è–∑–∫–æ–≤–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
# ---------------------------
required_columns = [
    "–î–∞—Ç–∞",
    "–¢–¢ –ú—ñ—Å—Ç–æ",
    "–ó–∞–ª–∏—à–æ–∫ –ø–æ —Ç–æ–≤–∞—Ä—É (—Ñ–∞–∫—Ç–∏—á–Ω–∏–π),–≥—Ä–Ω",
    "–í–∏—Ä—É—á–∫–∞ –∑–∞ –ª–∏—Å—Ç–æ–ø–∞–¥ 2025",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"
]

missing = set(required_columns) - set(df.columns)
if missing:
    st.error(f"–£ —Ñ–∞–π–ª—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing)}")
    st.stop()

# ---------------------------
# –û—á–∏—Å—Ç–∫–∞ —Ç–∞ —Ç–∏–ø–∏
# ---------------------------
df["–î–∞—Ç–∞"] = pd.to_datetime(df["–î–∞—Ç–∞"], errors="coerce")

numeric_cols = [
    "–ó–∞–ª–∏—à–æ–∫ –ø–æ —Ç–æ–≤–∞—Ä—É (—Ñ–∞–∫—Ç–∏—á–Ω–∏–π),–≥—Ä–Ω",
    "–í–∏—Ä—É—á–∫–∞ –∑–∞ –ª–∏—Å—Ç–æ–ø–∞–¥ 2025",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"
]

for col in numeric_cols:
    df[col] = pd.to_numeric(df[col], errors="coerce")

df["–ú—ñ—Å—è—Ü—å"] = df["–î–∞—Ç–∞"].dt.month
df["–†—ñ–∫"] = df["–î–∞—Ç–∞"].dt.year

# ---------------------------
# –°—Ç–∞—Ç—É—Å —Ä–µ–≤—ñ–∑—ñ—ó
# ---------------------------
def status(row):
    if pd.isna(row["–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö"]):
        return "‚ö†Ô∏è –õ—ñ—á–∏–ª—å–Ω–∏–∫"
    if row["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"] < 0:
        return "üî¥ –ú—ñ–Ω—É—Å"
    return "üü¢ –ü–ª—é—Å"

df["–°—Ç–∞—Ç—É—Å"] = df.apply(status, axis=1)

# ---------------------------
# –§—ñ–ª—å—Ç—Ä–∏
# ---------------------------
st.sidebar.header("–§—ñ–ª—å—Ç—Ä–∏")

city_filter = st.sidebar.multiselect(
    "–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞",
    sorted(df["–¢–¢ –ú—ñ—Å—Ç–æ"].dropna().unique())
)

year_filter = st.sidebar.multiselect(
    "–†—ñ–∫",
    sorted(df["–†—ñ–∫"].dropna().unique())
)

filtered_df = df.copy()

if city_filter:
    filtered_df = filtered_df[filtered_df["–¢–¢ –ú—ñ—Å—Ç–æ"].isin(city_filter)]

if year_filter:
    filtered_df = filtered_df[filtered_df["–†—ñ–∫"].isin(year_filter)]

# ---------------------------
# KPI
# ---------------------------
col1, col2, col3, col4 = st.columns(4)

col1.metric(
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–≤—ñ–∑—ñ–π",
    len(filtered_df)
)

col2.metric(
    "–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≥—Ä–Ω",
    int(filtered_df["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"].sum())
)

col3.metric(
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º—ñ–Ω—É—Å—ñ–≤",
    int((filtered_df["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"] < 0).sum())
)

col4.metric(
    "–°–µ—Ä–µ–¥–Ω—ñ–π –≥—Ä–∞–º–∞–∂",
    round(filtered_df["–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"].mean(), 2)
)

st.divider()

# ---------------------------
# –¢–∞–±–ª–∏—Ü—è
# ---------------------------
st.subheader("–ñ—É—Ä–Ω–∞–ª —Ä–µ–≤—ñ–∑—ñ–π")

display_cols = [
    "–î–∞—Ç–∞",
    "–¢–¢ –ú—ñ—Å—Ç–æ",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û",
    "–°—Ç–∞—Ç—É—Å"
]

st.dataframe(
    filtered_df[display_cols]
        .sort_values("–î–∞—Ç–∞", ascending=False),
    use_container_width=True
)

# ---------------------------
# –î–∞—à–±–æ—Ä–¥–∏
# ---------------------------
st.subheader("–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞")

col1, col2 = st.columns(2)

with col1:
    st.write("### –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø–æ –¥–∞—Ç–∞—Ö")
    chart_df = (
        filtered_df
        .groupby("–î–∞—Ç–∞")["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"]
        .sum()
        .reset_index()
    )
    st.line_chart(chart_df, x="–î–∞—Ç–∞", y="–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û")

with col2:
    st.write("### –°–µ—Ä–µ–¥–Ω—ñ–π –≥—Ä–∞–º–∞–∂ –ø–æ —Ç–æ—á–∫–∞—Ö")
    gram_df = (
        filtered_df
        .groupby("–¢–¢ –ú—ñ—Å—Ç–æ")["–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"]
        .mean()
        .reset_index()
        .sort_values("–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é")
    )
    st.bar_chart(
        gram_df,
        x="–¢–¢ –ú—ñ—Å—Ç–æ",
        y="–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"
    )
