import streamlit as st
import pandas as pd
import numpy as np

# =========================
# CONFIG
# =========================
st.set_page_config(
    page_title="–†–µ–≤—ñ–∑—ñ—ó –∫–∞–≤ º—è—Ä–µ–Ω—å",
    layout="wide"
)

st.title("üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ä–µ–≤—ñ–∑—ñ–π –∫–∞–≤ º—è—Ä–µ–Ω—å")

DEFAULT_FILE = "data.xlsx"

REQUIRED_COLUMNS = [
    "–î–∞—Ç–∞",
    "–ú—ñ–∂—Ä–µ–≤—ñ–∑—ñ–π–Ω–∏–π –ø–µ—Ä—ñ–æ–¥",
    "–¢–¢ –ú—ñ—Å—Ç–æ",
    "–ó–∞–ª–∏—à–æ–∫ –ø–æ —Ç–æ–≤–∞—Ä—É (—Ñ–∞–∫—Ç–∏—á–Ω–∏–π),–≥—Ä–Ω",
    "–í–∏—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä—ñ–æ–¥",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û",
    "–ö–æ–º–µ–Ω—Ç–∞—Ä —Ä–µ–≤—ñ–∑–æ—Ä–∞",
]

NUMERIC_COLUMNS = [
    "–ó–∞–ª–∏—à–æ–∫ –ø–æ —Ç–æ–≤–∞—Ä—É (—Ñ–∞–∫—Ç–∏—á–Ω–∏–π),–≥—Ä–Ω",
    "–í–∏—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä—ñ–æ–¥",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û",
]

# =========================
# FUNCTIONS
# =========================
def parse_revision_period(val):
    if pd.isna(val):
        return pd.NaT, pd.NaT, None
    try:
        start, end = val.split("-")
        start = pd.to_datetime(start.replace(",", "."), dayfirst=True)
        end = pd.to_datetime(end.replace(",", "."), dayfirst=True)
        return start, end, (end - start).days
    except Exception:
        return pd.NaT, pd.NaT, None


def load_data(file):
    df = pd.read_excel(file)

    missing = [c for c in REQUIRED_COLUMNS if c not in df.columns]
    if missing:
        st.error(f"‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏: {', '.join(missing)}")
        st.stop()

    for col in NUMERIC_COLUMNS:
        df[col] = pd.to_numeric(df[col], errors="coerce")

    df["–î–∞—Ç–∞"] = pd.to_datetime(df["–î–∞—Ç–∞"], dayfirst=True, errors="coerce")

    df[["–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É", "–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è", "–î–Ω—ñ–≤ –º—ñ–∂ —Ä–µ–≤—ñ–∑—ñ—è–º–∏"]] = (
        df["–ú—ñ–∂—Ä–µ–≤—ñ–∑—ñ–π–Ω–∏–π –ø–µ—Ä—ñ–æ–¥"]
        .apply(lambda x: pd.Series(parse_revision_period(x)))
    )

    return df


# =========================
# DATA LOAD
# =========================
st.sidebar.header("üìÇ –î–∞–Ω—ñ")

uploaded = st.sidebar.file_uploader("–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Excel", type=["xlsx"])

if uploaded:
    df = load_data(uploaded)
    st.sidebar.success("–§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ")
else:
    try:
        df = load_data(DEFAULT_FILE)
        st.sidebar.info("–§–∞–π–ª –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º")
    except Exception:
        st.warning("–ó–∞–≤–∞–Ω—Ç–∞–∂ Excel-—Ñ–∞–π–ª")
        st.stop()

# =========================
# MAIN TABLE
# =========================
st.subheader("üìã –¢–∞–±–ª–∏—Ü—è —Ä–µ–≤—ñ–∑—ñ–π")

show_comments = st.checkbox("–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä —Ä–µ–≤—ñ–∑–æ—Ä–∞", True)

cols = [
    "–î–∞—Ç–∞",
    "–¢–¢ –ú—ñ—Å—Ç–æ",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö",
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
    "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û",
]

if show_comments:
    cols.append("–ö–æ–º–µ–Ω—Ç–∞—Ä —Ä–µ–≤—ñ–∑–æ—Ä–∞")

st.dataframe(
    df[cols].sort_values("–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û", ascending=False),
    use_container_width=True,
    height=420
)

# =========================
# DASHBOARDS
# =========================

# ---- –§–Ü–ù–ê–ù–°–ò ----
st.divider()
st.subheader("üí∞ –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞")

c1, c2 = st.columns(2)

with c1:
    st.markdown("### üìâ –î–∏–Ω–∞–º—ñ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø–æ –¥–∞—Ç–∞—Ö")
    trend = (
        df.groupby("–î–∞—Ç–∞", as_index=False)["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"]
        .sum()
        .sort_values("–î–∞—Ç–∞")
    )
    st.line_chart(trend.set_index("–î–∞—Ç–∞")["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"])

with c2:
    st.markdown("### üî• TOP-10 –¢–¢ –∑ –Ω–∞–π–±—ñ–ª—å—à–∏–º —Ä–æ–∑—Ö–æ–¥–∂–µ–Ω–Ω—è–º")
    top10 = (
        df.groupby("–¢–¢ –ú—ñ—Å—Ç–æ", as_index=False)["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"]
        .sum()
        .sort_values("–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û", ascending=False)
        .head(10)
    )
    st.bar_chart(top10.set_index("–¢–¢ –ú—ñ—Å—Ç–æ")["–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û"])

# ---- –û–ü–ï–†–ê–¶–Ü–á ----
st.divider()
st.subheader("‚öôÔ∏è –û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞")

c3, c4 = st.columns(2)

with c3:
    st.markdown("### ‚òï –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö vs –ø—Ä–æ–ª–∏–≤–∏")
    scatter_df = df[["–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤", "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö"]].dropna()
    st.scatter_chart(
        scatter_df,
        x="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª–∏–≤—ñ–≤",
        y="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —á–∞—à–∫–∞—Ö"
    )

with c4:
    st.markdown("### ‚öñÔ∏è –°–µ—Ä–µ–¥–Ω—ñ–π –≥—Ä–∞–º–∞–∂ –ø–æ –¢–¢")
    avg_gram = (
        df.groupby("–¢–¢ –ú—ñ—Å—Ç–æ", as_index=False)
        ["–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"]
        .mean()
        .sort_values("–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é", ascending=False)
    )
    st.bar_chart(
        avg_gram.set_index("–¢–¢ –ú—ñ—Å—Ç–æ")
        ["–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"]
    )

# ---- –ö–û–ù–¢–†–û–õ–¨ –ö–ê–í–ò ----
st.divider()
st.subheader("üö® –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞–≤–∏")

target_gram = st.slider(
    "–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π –≥—Ä–∞–º–∞–∂ (–≥)",
    min_value=7.0,
    max_value=11.0,
    value=9.0,
    step=0.1
)

df["–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≥—Ä–∞–º–∞–∂—É"] = (
    df["–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é"] - target_gram
)

critical = df[df["–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≥—Ä–∞–º–∞–∂—É"].abs() > 0.3]

st.metric("–¢–¢ –∑ –∫—Ä–∏—Ç–∏—á–Ω–∏–º –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è–º", len(critical))

st.dataframe(
    critical[
        [
            "–¢–¢ –ú—ñ—Å—Ç–æ",
            "–§–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–≤–∏ –Ω–∞ –ø–æ—Ä—Ü—ñ—é",
            "–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≥—Ä–∞–º–∞–∂—É",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç –í–°–¨–û–ì–û",
            "–ö–æ–º–µ–Ω—Ç–∞—Ä —Ä–µ–≤—ñ–∑–æ—Ä–∞",
        ]
    ].sort_values("–í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≥—Ä–∞–º–∞–∂—É", ascending=False),
    use_container_width=True
)
